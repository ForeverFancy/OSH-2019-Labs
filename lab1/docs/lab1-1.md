# lab1-1 树莓派启动原理和过程

## 启动过程

1. 在树莓派刚刚通电时，CPU 未被开启，而 GPU 被启动，此时 SDRAM 也就是内存被禁用。在此阶段中，位于 Soc 中的 ROM 内的 BootLoader 会被 GPU 执行，这一段 BootLoader 用于从 SD 卡上的 FAT32 文件系统中加载下一阶段所需要的 BootLoader(bootcode.bin) 进入 L2 Cache，然后执行。

2. 第二阶段中的 bootcode.bin 会使能内存，在之前的树莓派中，接下来 GPU 会加载 loader.bin 进入内存并执行，但现在的树莓派已经不需要加载 loader.bin 文件了，GPU 会直接加载执行 start.elf，也就是 GPU 固件，然后进入第三阶段。

3. start.elf 首先阅读 config.txt，这个文本文件包含了很多系统硬件配置相关的参数，也包含内核的加载地址等信息。其次 start.elf 也会阅读 cmdline.txt ，这个文件包含启动内核时需要传递给内核的参数，这些参数在内核启动过程中需要传递给内核，用来初始化 CPU 的 clock 和串口等设备。接着 kernel.img 被加载到 GPU 分配的共享内存中，然后触发 CPU 的复位信号。

4. CPU 复位信号被触发之后，将内核解压缩，然后完成设备的初始化。接着启动 scheduler(0号进程)，init_task(1号进程) 和 kthreadd(2号进程)，kthreadd完成内核的初始化，然后创建 init(内核态)，接着演变为 init(用户态)，即用户态1号进程。init 按照 /etc/initab 文件要求完成内核的初始化。

## 与主流计算机启动的不同

主流计算机启动主要是由 BIOS 完成的。在 BIOS 中，主要是 CPU 来完成系统内核的加载启动，而在树莓派中，kernel.img被加载之前都是 GPU 在完成各种加载读取操作。

以及之前看过一些关于 BIOS 启动过程的文章，当时的笔记如下：

主流计算机的开机过程
* 打开电源，主板启动，检查固件组并让CPU启动。

* CPU启动后，多核CPU会令其中一个核为启动处理器，其他核成为应用处理器，处于终止状态直到操作系统启动。

* CPU启动时，会进入实模式(real-mode)，只允许使用20根地址线，即访问1MB内存。

* 虽然寄存器内存放的是16位的地址数据，实际计算时会使用段值右移4位再加偏移量得到20位地址。只需给出逻辑地址即可得到想要到达的物理地址。

* 大部分寄存器在启动时都设置了接通电源时的初始值，其中保存着CPU执行指令地址的地址寄存器(EIP)被初始化为`0xFFFFFFF0`，这个地址被称为`reset vector`，这也就是BIOS程序的入口地址。

* BIOS程序开始运行，触发通电自检，检查各种组件。

* 检查完成没有问题之后，BIOS会在扇区中寻找操作系统内核。BIOS会读取硬盘的前512个字节，即第一个扇区，这512个字节被称为主引导记录(Master Boot Record – MBR)。

* MBR通常包括操作系统引导程序和硬盘分区表，分区表的长度只有64个字节，里面又分成四项，每项16个字节。所以，一个硬盘最多只能分四个一级分区，又叫做"主分区"。BIOS把MBR加载到`0x7c00`的位置并且跳转到这一地址开始执行MBR中的指令。

* MBR中的代码有可能是`Windows loader`或者`Linux GRUB`等。
  > 传统的微软MBR代码会检查分区表，找出唯一一个标记为活动的分区，从这个分区中载入启动扇区并且运行扇区上的代码。启动扇区是这个分区上的第一个扇区，相对的MBR是整个磁盘的第一个扇区。\
  >或者控制权不交给这个活动分区，而是交给`boot loader`，比如`GRUB`，由它来将操作系统载入内核。
  
* 当操作系统被全部加载到内存之后，整个启动过程就算是结束了。

## 树莓派启动过程中用到的文件系统

在启动过程的第1步中提到，第1步中的 BootLoader 需要从 SD 卡中的文件 FAT32 文件系统中读取第2阶段所需要的 BootLoader。
创建进程时会用到Linux的文件系统，也就是 ext4 文件系统。