# 利用汇编实现LED闪烁

## 实现思路

在`test.s`的基础上已经知道了如何打开 GPIO 29，要实现闪烁功能就要每隔一段时间间隔将 GPIO 29 关闭，时间间隔由内存地址为`0x3F003000`的计时器的低4位提供。先点亮 LED 灯，要进行`delay`操作时，先记录下开始操作的时间（也就是 counter 的值，存放在`r3`中），然后进入循环，每次进入循环读取当前 counter 值（存放在`r7`中），当`r7-r3>=1000000`时，代表时间过了大概1s，于是熄灭 LED。再经过一个同样的`delay`操作之后点亮 LED 灯，如此循环下去即可。代码如下：

```arm
.section .init
.global _start

_start:

ldr r0, =0x3F200000

mov r1,#1
lsl r1,#27
str r1,[r0,#8]

mov r1,#1
lsl r1,#29
str r1,[r0,#28]

ldr r2,=0x3F003000
ldr r8,=0x000f4240

loop:
    str r1,[r0,#28]
    ldr r3, [r2, #4]
    delay:
        ldr r7, [r2, #4]
	sub r7,r7,r3
	cmp r7,r8
	blt delay
    str r1,[r0,#40]
    ldr r3, [r2, #4]
    delay2:
        ldr r7, [r2, #4]
        sub r7,r7,r3
        cmp r7,r8
        blt delay2
b loop

```

## 问题1

由于树莓派还是要进行启动的操作，启动之后只运行 led 程序，所以比较重要的是与启动相关的`bootcode.bin`(用于加载`start.elf`),`start.elf`(第三步中加载内核的主要固件)。

## 问题2

由于 kernel 只是一个控制 led 闪烁的程序，所以并不需要使用第二分区（第二分区通常作为linux的根目录，而 led.img 并不需要）。

## 问题3

- `as`是汇编工具，将我们所写的汇编代码转为机器指令，生成目标文件。
- `ld`是链接器，负责将一个或者多个目标文件及用到的库链接在一起，生成可执行文件。
- `objcopy`的作用是将目标文件的一部分或者全部内容拷贝到另外一个目标文件中，或者实现目标文件的格式转换。它负责把上一步生成`led.elf`转换为`led.img`。
- 在我们日常编译程序，需要用到上述的`as`和`ld`，因为链接一般是编译的最后一步，而且我们大多数情况下都不需要格式转换，故一般不会用`objcopy`。
